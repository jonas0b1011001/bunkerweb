{% extends "base.html" %}
{% block content %}
<div class="col-span-12 lg:col-span-12 p-4 w-full bg-white dark:bg-slate-850 shadow-md rounded-2xl">
    <div id="update-indicator">
        <svg width="32" height="32" viewBox="0 0 32 32" style="margin-right: 10px;transform: rotateY(-180deg) rotateZ(-90deg)">
            <circle cx="16" cy="16" r="14" stroke="#4BC0C0" stroke-width="3" fill="none" stroke-dasharray="88" stroke-dashoffset="88"></circle>
        </svg>
        <button class="time-filter" data-range="1hr">1 Hour</button>
        <button class="time-filter" data-range="24hrs">24 Hours</button>
        <button class="time-filter" data-range="7d">7 Days</button>
        <button class="time-filter" data-range="30d">30 Days</button>
        <button class="time-filter active" data-range="max">Max</button>
        <button class="customize-btn" id="toggle-edit-mode">⚙️</button>
    </div>
</div>

<div class="col-span-12 lg:col-span-12">
    <div id="statistics-content" class="grid grid-cols-12 gap-4">
        <div id="total_requests_container" class="statistics-item col-span-3 lg:col-span-3 p-4 hover:scale-102 w-full bg-white dark:bg-slate-850 shadow-md rounded-2xl" data-id="0" style="text-align:center"></div>
        <div id="4xx_error_container" class="statistics-item col-span-3 lg:col-span-3 p-4 hover:scale-102 w-full bg-white dark:bg-slate-850 shadow-md rounded-2xl" data-id="1" style="text-align:center"></div>
        <div id="5xx_error_container" class="statistics-item col-span-3 lg:col-span-3 p-4 hover:scale-102 w-full bg-white dark:bg-slate-850 shadow-md rounded-2xl" data-id="2" style="text-align:center"></div>
        <div id="unique_ips_container" class="statistics-item col-span-3 lg:col-span-3 p-4 hover:scale-102 w-full bg-white dark:bg-slate-850 shadow-md rounded-2xl" data-id="3" style="text-align:center"></div>
        <div id="top_hosts_container" class="statistics-item col-span-6 lg:col-span-4 p-4 hover:scale-102 w-full bg-white dark:bg-slate-850 shadow-md rounded-2xl" data-id="4"></div>
        <div id="top_useragents_container" class="statistics-item col-span-6 lg:col-span-4 p-4 hover:scale-102 w-full bg-white dark:bg-slate-850 shadow-md rounded-2xl" data-id="5"></div>
        <div id="top_countries_container" class="statistics-item col-span-6 lg:col-span-4 p-4 hover:scale-102 w-full bg-white dark:bg-slate-850 shadow-md rounded-2xl" data-id="6"></div>
        <div id="top_asns_container" class="statistics-item col-span-6 lg:col-span-4 p-4 hover:scale-102 w-full bg-white dark:bg-slate-850 shadow-md rounded-2xl" data-id="7"></div>
        <div id="requests_container" class="statistics-item col-span-12 lg:col-span-8 p-4 hover:scale-102 w-full bg-white dark:bg-slate-850 shadow-md rounded-2xl" data-id="8"><h4>Requests over Time</h4><canvas id="requestTimelineChart"></canvas></div>
        <div id="statuscodes_container" class="statistics-item col-span-6 lg:col-span-4 p-4 hover:scale-102 w-full bg-white dark:bg-slate-850 shadow-md rounded-2xl" data-id="9"><h4>Status Codes</h4><canvas id="statusCodesChart"></canvas></div>
        <div id="top_ips_container" class="statistics-item col-span-6 lg:col-span-4 p-4 hover:scale-102 w-full bg-white dark:bg-slate-850 shadow-md rounded-2xl" data-id="10"><h4>Top IPs</h4><canvas id="topIPsChart"></canvas></div>
    </div>
</div>
<div id="hidden-items" class="col-span-12 p-4 w-full bg-white dark:bg-slate-850 shadow-md rounded-2xl">
    <h4>Hidden Items</h4>
    <div id="parked-items" class="grid grid-cols-12 gap-4"></div>
</div>

<script nonce="{{ script_nonce }}">
    let updateInterval = 60;  // Update-Intervall (in Sekunden)
    let timeLeft = updateInterval;  // Zeit bis zur nächsten Aktualisierung
    let activeRange = 'max';  // Standardmäßig 24 Stunden als ausgewählter Filter
    let editMode = false;  // Editiermodus aus
    let timer;  // Referenz für das setInterval
    let statuscode_chart;
    let ip_chart;
    let requests_chart;

    let hidden = localStorage.getItem('hidden') || '';
    hidden.split('|').forEach(dataid => {
        let temp = document.querySelector(`[data-id="${dataid}"]`);
        if (temp){
            temp.style.display = 'none';
            document.getElementById('parked-items').appendChild(temp);
            temp.style.display = 'block';  // Im Parkbereich sichtbar, aber mit rotem Rahmen
            temp.classList.add('parked');
        }
    });

    let sortable_main = Sortable.create(document.getElementById('statistics-content'), {
        group: 'stats',  // Elemente können zwischen den Bereichen verschoben werden
        disabled: true,
        store: {
                /**
                 * Get the order of elements. Called once during initialization.
                 * @param   {Sortable}  sortable
                 * @returns {Array}
                 */
                get: function (sortable) {
                    var order = localStorage.getItem(sortable.options.group.name);
                    return order ? order.split('|') : [];
                },

                /**
                 * Save the order of elements. Called onEnd (when the item is dropped).
                 * @param {Sortable}  sortable
                 */
                set: function (sortable) {
                    var order = sortable.toArray();
                    localStorage.setItem(sortable.options.group.name, order.join('|'));
                }
        },
        animation: 150
    });

    // Parkbereich Sortable machen
    let sortable_hidden = Sortable.create(document.getElementById('parked-items'), {
        group: 'hidden',  // Erlaubt das Verschieben von Elementen zwischen Parkbereich und Hauptbereich
        disabled: true,
        store: {
                    /**
                     * Get the order of elements. Called once during initialization.
                     * @param   {Sortable}  sortable
                     * @returns {Array}
                     */
                     get: function (sortable) {
                        var order = localStorage.getItem(sortable.options.group.name);
                        return order ? order.split('|') : [];
                    },

                    /**
                     * Save the order of elements. Called onEnd (when the item is dropped).
                     * @param {Sortable}  sortable
                     */
                    set: function (sortable) {
                        var order = sortable.toArray();
                        localStorage.setItem(sortable.options.group.name, order.join('|'));
                    }
                },
        animation: 150
    });

    document.querySelectorAll('.time-filter').forEach(button => {
        button.addEventListener('click', function() {
            // Filter-Auswahl visuell hervorheben
            document.querySelectorAll('.time-filter').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            activeRange = this.getAttribute('data-range');

            // Daten sofort neu laden und Timer zurücksetzen
            resetTimer();
            fetchStatistics(activeRange);
        });
    });

    // Initiales Laden der Daten (standardmäßig "max")
    fetchStatistics('max');

    // Datenabruf-Funktion
    function fetchStatistics(range) {
        fetch(`{{ url_for('statistics') }}/data?range=${range}`)
            .then(response => response.json())
            .then(data => renderStatistics(data))
            .catch(error => console.error('Error fetching data:', error));
    }

    function renderStatistics(data) {

        // Rebuild containers with updated data
        document.getElementById('total_requests_container').innerHTML = `<h4>Total requests</h4><strong>${data.total_requests}</strong>`;
        document.getElementById('4xx_error_container').innerHTML = `<h4>4xx Error</h4><strong>${data.requests_4xx_percent}%</strong>`;
        document.getElementById('5xx_error_container').innerHTML = `<h4>5xx Error</h4><strong>${data.requests_5xx_percent}%</strong>`;
        document.getElementById('unique_ips_container').innerHTML = `<h4>Unique IPs</h4><strong>${data.unique_ips}</strong>`;

        let _hosts = '';
        data.hosts.slice(0, 5).forEach(([host, count]) => {
            const percentage = (count / data.total_requests) * 100;
            _hosts += `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between;">
                            <div style="font-size: 14px;">${host}</div>
                            <div style="font-size: 14px; font-weight: bold;">${count}</div>
                        </div>
                        <div style="background-color: #67748e; border-radius: 5px; height: 10px; position: relative; margin-top: 5px;">
                            <div style="height: 100%; background-color: #f6bf42; border-radius: 5px; width: ${percentage}%;"></div>
                        </div>
                    </div>
            `;
        });        
        document.getElementById('top_hosts_container').innerHTML = `<h4>Popular hosts</h4>${_hosts}`;

        let _uas = '';
        data.user_agents.slice(0, 5).forEach(([ua, count]) => {
            const percentage = (count / data.total_requests) * 100;
            _uas += `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between;">
                            <div style="font-size: 14px;" title='${ua}'>${ua.substring(0,30)}</div>
                            <div style="font-size: 14px; font-weight: bold;">${count}</div>
                        </div>
                        <div style="background-color: #67748e; border-radius: 5px; height: 10px; position: relative; margin-top: 5px;">
                            <div style="height: 100%; background-color: #f64279; border-radius: 5px; width: ${percentage}%;"></div>
                        </div>
                    </div>
            `;
        });
        document.getElementById('top_useragents_container').innerHTML = `<h4>Top User Agents</h4>${_uas}`;

        let _countries = '';
        data.countries.slice(0, 5).forEach(([ctry, count]) => {
            const percentage = (count / data.total_requests) * 100;
            _countries += `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between;">
                            <div style="font-size: 14px;">${ctry}</div>
                            <div style="font-size: 14px; font-weight: bold;">${count}</div>
                        </div>
                        <div style="background-color: #67748e; border-radius: 5px; height: 10px; position: relative; margin-top: 5px;">
                            <div style="height: 100%; background-color: #42f6bf; border-radius: 5px; width: ${percentage}%;"></div>
                        </div>
                    </div>
            `;
        });
        document.getElementById('top_countries_container').innerHTML = `<h4>Top Countries</h4>${_countries}`;

        let _asn = '';
        data.asns.slice(0, 5).forEach(([asn, count]) => {
            const percentage = (count / data.total_requests) * 100;
            _asn += `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between;">
                            <div style="font-size: 14px;">${asn}</div>
                            <div style="font-size: 14px; font-weight: bold;">${count}</div>
                        </div>
                        <div style="background-color: #67748e; border-radius: 5px; height: 10px; position: relative; margin-top: 5px;">
                            <div style="height: 100%; background-color: #4279f6; border-radius: 5px; width: ${percentage}%;"></div>
                        </div>
                    </div>
            `;
        });
        document.getElementById('top_asns_container').innerHTML = `<h4>Top ASN</h4>${_asn}`;

        const colors = [
            'rgba(54, 162, 235, 1)',   // Blau
            'rgba(255, 99, 132, 1)',   // Rot
            'rgba(255, 206, 86, 1)',   // Gelb
            'rgba(75, 192, 192, 1)',   // Grün
            'rgba(153, 102, 255, 1)',  // Lila
            'rgba(255, 159, 64, 1)',   // Orange
            'rgba(50, 205, 50, 1)',    // Dunkelgrün
            'rgba(0, 255, 255, 1)',    // Cyan
            'rgba(178, 34, 34, 1)',    // Dunkelrot
            'rgba(139, 69, 19, 1)'     // Braun
        ];

        statuscode_chart?.destroy();
        statuscode_chart = new Chart(document.getElementById('statusCodesChart'), {
            type: 'doughnut',
            data: {
                labels: data.status_codes.map((x) => x[0]),
                datasets: [{
                    label: 'Status-Codes',
                    data: data.status_codes.map((x) => x[1]),
                    backgroundColor: colors,
                    borderColor: colors,
                    borderWidth: 1
                }]
            }
        });

        ip_chart?.destroy();
        ip_chart = new Chart(document.getElementById('topIPsChart'), {
            type: 'doughnut',
            data: {
                labels: data.ips.slice(0, 5).map((x) => x[0]),
                datasets: [{
                    label: 'Top IPs',
                    data: data.ips.slice(0, 5).map((x) => x[1]),
                    backgroundColor: colors,
                    borderColor: colors
                }]
            }
        });

        const ctx = document.getElementById('requestTimelineChart').getContext('2d');
        data.request_timeline.sort(function(a, b){return Date.parse(a[0]) - Date.parse(b[0])});
        while (data.request_timeline[0][1] == 0) {
            data.request_timeline.shift();
        }
        const labels = data.request_timeline.map(item => item[0]);  // Zeitpunkte
        const values = data.request_timeline.map(item => item[1]);  // Anzahl der Requests

        requests_chart?.destroy();
        requests_chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,  // Zeitachsen
                datasets: [{
                    label: 'Number of Requests',
                    data: values,  // Anzahl der Requests pro Zeitintervall
                    fill: false,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    tension: 0.1  // Glatte Kurvenlinie
                }]
            },
            options: {
                responsive: true, // Chart ist responsive
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        },
                        ticks: {
                            autoSkip: true, // Bei kleinen Bildschirmen werden weniger Labels angezeigt
                            maxTicksLimit: 5, // Begrenzung der maximalen Anzahl an Ticks
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Requests'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Funktion zum Zurücksetzen des Timers
    function resetTimer() {
        clearInterval(timer);  // Aktuellen Timer stoppen
        timeLeft = updateInterval;  // Timer auf Ausgangszeit zurücksetzen
        startTimer();  // Timer erneut starten
    }

    // Timer-Logik
    function startTimer() {
        timer = setInterval(updateTimer, 1000);  // Jede Sekunde aktualisieren
    }

    // Aktualisierungsfunktion und Timer-Logik
    function updateTimer() {
        if (editMode){
            return; //halt while editing
        }
        const circle = document.querySelector('#update-indicator circle');
        const dashArray = 88;  // Voller Umfang des Kreises
        const dashOffset = (1 - (timeLeft / updateInterval)) * dashArray;
        circle.style.strokeDashoffset = dashOffset;

        timeLeft--;

        if (timeLeft == 0) {
            timeLeft = updateInterval;
            fetchStatistics(activeRange);  // Daten neu laden
        }
    }

    // Starte den Timer nach dem Initialen Laden
    startTimer();

    // Funktion zum Umschalten des Editiermodus
    function toggleEditMode() {
        editMode = !editMode;

        document.querySelectorAll('.statistics-item').forEach(div => {
            const toggleButton = div.querySelector('.toggle-visibility-btn');

            // Falls kein Toggle-Button existiert, fügen wir ihn hinzu
            if (!toggleButton) {
                const newToggleButton = document.createElement('button');
                newToggleButton.innerText = !div.classList.contains('parked') ? 'Hide' : 'Show';
                newToggleButton.classList.add('toggle-visibility-btn');
                if (div.classList.contains('parked'))
                newToggleButton.classList.add('parked');
                newToggleButton.addEventListener('click', function() {
                    if (!div.classList.contains('parked')) {
                        // Element verstecken (ins Parkbereich verschieben)
                        div.style.display = 'none';
                        document.getElementById('parked-items').appendChild(div);
                        div.style.display = 'block';  // Im Parkbereich sichtbar, aber mit rotem Rahmen
                        div.classList.add('parked');
                        newToggleButton.classList.add('parked')
                        newToggleButton.innerText = 'Show';
                    } else {
                        // Element wieder sichtbar machen (ins Hauptbereich verschieben)
                        div.style.display = 'none';
                        document.getElementById('statistics-content').appendChild(div);
                        div.style.display = 'block';  // Im Hauptbereich sichtbar
                        div.classList.remove('parked');
                        newToggleButton.classList.remove('parked');
                        newToggleButton.innerText = 'Hide';
                    }
                    sortable_main.save();
                    sortable_hidden.save();
                });
                div.prepend(newToggleButton);
            }

            // Buttons nur im Editiermodus sichtbar machen
            if (editMode) {
                div.classList.add('editable');
                div.querySelector('.toggle-visibility-btn').style.display = 'inline-block';
            } else {
                div.classList.remove('editable');
                div.querySelector('.toggle-visibility-btn').style.display = 'none';
            }
        });

        // Parkbereich für ausgeblendete Divs sichtbar machen
        document.getElementById('hidden-items').style.display = editMode ? 'block' : 'none';

        // Drag-and-Drop-Funktionalität aktivieren/deaktivieren
        sortable_main.option("disabled", !editMode);
        sortable_hidden.option("disabled", !editMode);
    }

    // Initialer Aufruf, um den Editiermodus hinzuzufügen
    document.getElementById('toggle-edit-mode').addEventListener('click', toggleEditMode);

    // Parkbereich standardmäßig ausblenden
    document.getElementById('hidden-items').style.display = 'none';
</script>
{% endblock content %}